datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ROLE-BASED ENUMS
// ============================================
enum UserRole {
  ADMIN
  COACH
  CLIENT
}

enum BodyZone {
  HEAD
  THROAT
  CHEST
  SOLAR_PLEXUS
  BELLY
  PELVIS
  ARMS
  LEGS
  FULL_BODY
}

enum ClientType {
  REGISTERED // Has User account (accepted invitation)
  OFFLINE // Manually added, no User account
  INVITED // Invitation sent but not yet accepted
}

enum AvailabilityStatus {
  OPEN
  HELD
  BOOKED
}

enum GoalType {
  OKR
  SMART
  HABIT
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// ============================================
// USER & AUTHENTICATION
// ============================================
model User {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  email    String? @unique
  username String? @unique

  // ROLE MANAGEMENT
  role    UserRole @default(COACH) // Public signups default to COACH
  isAdmin Boolean  @default(false)

  // INTERNATIONALIZATION
  preferredLanguage String? @default("he")

  // PROFILE RELATIONS (1:1)
  coachProfile  CoachProfile?
  clientProfile ClientProfile?

  // SUBSCRIPTION (Relevant for COACH only)
  paymentProcessorUserId        String?   @unique
  lemonSqueezyCustomerPortalUrl String?
  subscriptionStatus            String? // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan              String? // 'starter', 'pro'
  datePaid                      DateTime?
  credits                       Int       @default(3)

  // TRANZILLA TOKENIZATION
  tranzillaToken String? // TranzilaTK for auto-renewal

  // SUBSCRIPTION RENEWAL RETRY TRACKING (Tranzilla)
  subscriptionRetryCount      Int       @default(0) // Number of failed renewal attempts
  lastRetryAttempt            DateTime? // Timestamp of last renewal attempt
  subscriptionNextRetryDate    DateTime? // When to attempt next renewal

  // BOILERPLATE FIELDS
  isEmailVerified        Boolean @default(false)
  emailVerificationToken String?
  passwordResetToken     String?

  // ONBOARDING
  onboardingCompleted Boolean @default(false)
  onboardingSteps     Json? // Tracks completed onboarding steps per role

  // NOTIFICATIONS (Phase 3)
  notifications           Notification[]
  notificationPreferences NotificationPreferences?

  contactFormMessages ContactFormMessage[]
  files               File[]
}

// ============================================
// ROLE-SPECIFIC PROFILES
// ============================================
model CoachProfile {
  id        String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String    @unique
  deletedAt DateTime?

  // A Coach manages many Clients
  clients     ClientProfile[]
  invitations ClientInvitation[]

  // Sessions logged by this Coach
  sessions CoachSession[]

  // Resources uploaded by this Coach
  resources Resource[]

  // Availability slots for scheduling
  availabilitySlots AvailabilitySlot[]
}

model ClientProfile {
  id        String    @id @default(uuid())
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?   @unique
  deletedAt DateTime?

  // A Client belongs to one Coach
  coach   CoachProfile? @relation(fields: [coachId], references: [id])
  coachId String?

  // OFFLINE CLIENT SUPPORT
  clientType       ClientType @default(OFFLINE) // REGISTERED, OFFLINE, or INVITED
  displayName      String? // Name for offline clients
  contactEmail     String? // Optional contact email (not for auth)
  avatarS3Key      String? // S3 key for client avatar photo
  lastActivityDate DateTime? // Track for "Inactive" status badge

  // The Core Feature: Somatic Logs (replaces Tasks)
  somaticLogs SomaticLog[]

  // Sessions logged by Coach
  sessions CoachSession[]

  // MODULE 10: Recurring Session Schedule
  scheduleDay      Int? // 0-6 (Sunday-Saturday)
  scheduleTime     String? // "14:00" (24h format)
  scheduleTimezone String? // IANA timezone (e.g., "America/New_York")
  nextSessionDate  DateTime? // Computed next session date in UTC
  sessionCount     Int       @default(0) // Total sessions completed

  // MODULE 11: Goals & Milestones
  goals Goal[]

  // ANALYTICS: Somatic pattern insights (cached)
  analytics SomaticLogAnalytics[]

  availabilitySlots AvailabilitySlot[]

  @@index([coachId])
}

// ============================================
// SOMATIC LOG ANALYTICS (Cached Insights)
// ============================================
model SomaticLogAnalytics {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  period          String // "30d", "90d", "365d"
  computedAt      DateTime // When this snapshot was computed
  periodStartDate DateTime // Analysis window start
  periodEndDate   DateTime // Analysis window end

  topBodyZones           Json // [{zone: string, count: int, avgIntensity: float}]
  topSensations          Json // [{sensation: string, count: int, avgIntensity: float}]
  intensityTrendOverTime Json // [{weekStart: ISO date, avgIntensity: float}]
  totalLogsInPeriod      Int // Total somatic logs in this period

  @@unique([clientId, period])
  @@index([clientId])
  @@index([computedAt])
}

// ============================================
// CLIENT INVITATIONS
// ============================================
model ClientInvitation {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  coachId   String
  status    String    @default("PENDING") // PENDING, ACCEPTED
  createdAt DateTime  @default(now())
  expiresAt DateTime
  deletedAt DateTime?

  // Link to coach so they can see pending invites
  coach CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId, status])
}

// ============================================
// SOMATIC LOGS (Core Feature)
// ============================================
model SomaticLog {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  // The Data Point
  bodyZone  BodyZone
  sensation String // e.g., "Tight", "Hot", "Vibrating"
  intensity Int // 1-10 scale
  note      String?  @db.Text

  // SHARING CONTROL
  sharedWithCoach Boolean @default(true) // Controls coach visibility

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  @@index([clientId, createdAt])
  @@index([clientId, sharedWithCoach, deletedAt])
}

// ============================================
// COACH SESSIONS (Module 9: Session Recaps)
// ============================================
model CoachSession {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  sessionDate DateTime  @default(now())
  deletedAt   DateTime?

  // MODULE 10: Session tracking
  sessionNumber Int? // Auto-incremented for each client's sessions
  topic         String? // e.g., "Work Stress"

  // Coach-visible only
  privateNotes String? @db.Text

  // Visible to both Coach and Client
  sharedSummary String? @db.Text

  // HARMONY UPDATE: Somatic Anchor & Resource Attachments
  somaticAnchor BodyZone? // Body zone discussed in session
  resources     Resource[] // Resources attached as homework

  // Relations
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId String

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  @@index([coachId, sessionDate])
  @@index([clientId, sessionDate])
  @@index([clientId, sessionDate, deletedAt])
}

model AvailabilitySlot {
  id        String             @id @default(uuid())
  coach     CoachProfile       @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId   String
  client    ClientProfile?     @relation(fields: [clientId], references: [id])
  clientId  String?
  startTime DateTime
  endTime   DateTime
  timezone  String
  status    AvailabilityStatus @default(OPEN)
  notes     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  deletedAt DateTime?

  @@index([coachId, startTime, deletedAt])
  @@index([clientId, startTime, deletedAt])
}

// ============================================
// GOALS & MILESTONES (Module 11)
// ============================================
model Goal {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  title    String
  type     GoalType   @default(OKR)
  status   GoalStatus @default(NOT_STARTED)
  progress Int        @default(0) // 0-100, calculated from milestones
  dueDate  DateTime?

  // Relations
  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  // Milestones for this goal
  milestones Milestone[]

  @@index([clientId, status])
  @@index([clientId, deletedAt])
  @@index([clientId, dueDate])
}

model Milestone {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  text      String
  completed Boolean @default(false)
  order     Int     @default(0) // For ordering within a goal

  // Relations
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)
  goalId String
}

// ============================================
// FILE UPLOADS
// ============================================
model File {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  user   User   @relation(fields: [userId], references: [id])
  userId String

  name  String
  type  String
  s3Key String

  @@index([userId, deletedAt])
}

// ============================================
// RESOURCE LIBRARY (Module 8)
// ============================================
model Resource {
  id          String    @id @default(uuid())
  name        String
  type        String // MIME type: "application/pdf", "image/jpeg", "audio/mpeg", etc.
  s3Key       String
  description String? // Optional description for coaches
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?

  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId String

  // HARMONY UPDATE: Resource can be attached to sessions
  sessions CoachSession[] // Sessions where this resource was prescribed

  @@index([coachId])
  @@index([coachId, deletedAt])
}

// ============================================
// ANALYTICS & ADMIN
// ============================================
model DailyStats {
  id   Int      @id @default(autoincrement())
  date DateTime @unique @default(now())

  totalViews                Int    @default(0)
  prevDayViewsChangePercent String @default("0")
  userCount                 Int    @default(0)
  paidUserCount             Int    @default(0)
  userDelta                 Int    @default(0)
  paidUserDelta             Int    @default(0)
  totalRevenue              Float  @default(0)
  totalProfit               Float  @default(0)

  sources PageViewSource[]
}

model PageViewSource {
  name String
  date DateTime @default(now())

  dailyStats   DailyStats? @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId Int?

  visitors Int

  @@id([date, name])
}

model Logs {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  message String
  level   String
}

model ContactFormMessage {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  content   String
  isRead    Boolean   @default(false)
  repliedAt DateTime?
}

// ============================================
// NOTIFICATIONS (Phase 3)
// ============================================
model Notification {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  type    String // "SESSION_REMINDER", "SESSION_SUMMARY_POSTED", "RESOURCE_SHARED"
  title   String
  message String  @db.Text
  read    Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  metadata Json? // {sessionId, resourceId, clientId, etc}

  @@index([userId, read])
  @@index([createdAt])
}

model NotificationPreferences {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  emailSessionReminders Boolean @default(true)
  emailSessionSummaries Boolean @default(true)
  emailResourceShared   Boolean @default(true)

  inAppSessionReminders Boolean @default(true)
  inAppSessionSummaries Boolean @default(true)
  inAppResourceShared   Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

// ============================================
// TRANZILLA TRANSACTIONS
// ============================================
model TranzillaTransaction {
  id            String   @id @default(uuid())
  transactionId String   @unique
  userId        String
  amount        Float
  response      String
  tranzilaTK    String?
  processedAt   DateTime @default(now())
}
