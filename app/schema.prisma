datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ROLE-BASED ENUMS
// ============================================
enum UserRole {
  ADMIN
  COACH
  CLIENT
}

enum BodyZone {
  HEAD
  THROAT
  CHEST
  SOLAR_PLEXUS
  BELLY
  PELVIS
  ARMS
  LEGS
  FULL_BODY
}

enum ClientType {
  REGISTERED  // Has User account (accepted invitation)
  OFFLINE     // Manually added, no User account
  INVITED     // Invitation sent but not yet accepted
}

enum GoalType {
  OKR
  SMART
  HABIT
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// ============================================
// USER & AUTHENTICATION
// ============================================
model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique

  // ROLE MANAGEMENT
  role                      UserRole        @default(COACH) // Public signups default to COACH
  isAdmin                   Boolean         @default(false)

  // INTERNATIONALIZATION
  preferredLanguage         String?         @default("he")

  // PROFILE RELATIONS (1:1)
  coachProfile              CoachProfile?
  clientProfile             ClientProfile?

  // SUBSCRIPTION (Relevant for COACH only)
  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'starter', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(3)

  // TRANZILLA TOKENIZATION
  tranzillaToken            String?         // TranzilaTK for auto-renewal

  // BOILERPLATE FIELDS
  isEmailVerified           Boolean         @default(false)
  emailVerificationToken    String?
  passwordResetToken        String?

  // ONBOARDING
  onboardingCompleted       Boolean         @default(false)
  onboardingSteps           Json?           // Tracks completed onboarding steps per role

  contactFormMessages       ContactFormMessage[]
  files                     File[]
}

// ============================================
// ROLE-SPECIFIC PROFILES
// ============================================
model CoachProfile {
  id      String          @id @default(uuid())
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String          @unique

  // A Coach manages many Clients
  clients ClientProfile[]
  invitations ClientInvitation[]

  // Sessions logged by this Coach
  sessions CoachSession[]

  // Resources uploaded by this Coach
  resources Resource[]
}

model ClientProfile {
  id      String          @id @default(uuid())
  user    User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String?         @unique

  // A Client belongs to one Coach
  coach   CoachProfile?   @relation(fields: [coachId], references: [id])
  coachId String?

  // OFFLINE CLIENT SUPPORT
  clientType       ClientType  @default(OFFLINE)  // REGISTERED, OFFLINE, or INVITED
  displayName      String?                        // Name for offline clients
  contactEmail     String?                        // Optional contact email (not for auth)
  avatarS3Key      String?                        // S3 key for client avatar photo
  lastActivityDate DateTime?                      // Track for "Inactive" status badge

  // The Core Feature: Somatic Logs (replaces Tasks)
  somaticLogs SomaticLog[]

  // Sessions logged by Coach
  sessions CoachSession[]

  // MODULE 10: Recurring Session Schedule
  scheduleDay      Int?      // 0-6 (Sunday-Saturday)
  scheduleTime     String?   // "14:00" (24h format)
  scheduleTimezone String?   // IANA timezone (e.g., "America/New_York")
  nextSessionDate  DateTime? // Computed next session date in UTC
  sessionCount     Int       @default(0) // Total sessions completed

  // MODULE 11: Goals & Milestones
  goals            Goal[]
}

// ============================================
// CLIENT INVITATIONS
// ============================================
model ClientInvitation {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  coachId   String
  status    String   @default("PENDING") // PENDING, ACCEPTED
  createdAt DateTime @default(now())
  expiresAt DateTime

  // Link to coach so they can see pending invites
  coach     CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
}

// ============================================
// SOMATIC LOGS (Core Feature)
// ============================================
model SomaticLog {
  id                String      @id @default(uuid())
  createdAt         DateTime    @default(now())

  // The Data Point
  bodyZone          BodyZone
  sensation         String      // e.g., "Tight", "Hot", "Vibrating"
  intensity         Int         // 1-10 scale
  note              String?     @db.Text

  // SHARING CONTROL
  sharedWithCoach   Boolean     @default(true) // Controls coach visibility

  client            ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId          String
}

// ============================================
// COACH SESSIONS (Module 9: Session Recaps)
// ============================================
model CoachSession {
  id            String        @id @default(uuid())
  createdAt     DateTime      @default(now())
  sessionDate   DateTime      @default(now())

  // MODULE 10: Session tracking
  sessionNumber Int?          // Auto-incremented for each client's sessions
  topic         String?       // e.g., "Work Stress"

  // Coach-visible only
  privateNotes  String?       @db.Text

  // Visible to both Coach and Client
  sharedSummary String?       @db.Text

  // HARMONY UPDATE: Somatic Anchor & Resource Attachments
  somaticAnchor BodyZone?     // Body zone discussed in session
  resources     Resource[]    // Resources attached as homework

  // Relations
  coach         CoachProfile  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId       String

  client        ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId      String
}

// ============================================
// GOALS & MILESTONES (Module 11)
// ============================================
model Goal {
  id            String        @id @default(uuid())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  title         String
  type          GoalType      @default(OKR)
  status        GoalStatus    @default(NOT_STARTED)
  progress      Int           @default(0)  // 0-100, calculated from milestones
  dueDate       DateTime?

  // Relations
  client        ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId      String

  // Milestones for this goal
  milestones    Milestone[]
}

model Milestone {
  id            String        @id @default(uuid())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  text          String
  completed     Boolean       @default(false)
  order         Int           @default(0)  // For ordering within a goal

  // Relations
  goal          Goal          @relation(fields: [goalId], references: [id], onDelete: Cascade)
  goalId        String
}

// ============================================
// FILE UPLOADS
// ============================================
model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  type                      String
  s3Key                     String
}

// ============================================
// RESOURCE LIBRARY (Module 8)
// ============================================
model Resource {
  id          String        @id @default(uuid())
  name        String
  type        String        // MIME type: "application/pdf", "image/jpeg", "audio/mpeg", etc.
  s3Key       String
  description String?       // Optional description for coaches
  createdAt   DateTime      @default(now())

  coach       CoachProfile  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId     String

  // HARMONY UPDATE: Resource can be attached to sessions
  sessions    CoachSession[] // Sessions where this resource was prescribed
}

// ============================================
// ANALYTICS & ADMIN
// ============================================
model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}

model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}

// ============================================
// TRANZILLA TRANSACTIONS
// ============================================
model TranzillaTransaction {
  id            String   @id @default(uuid())
  transactionId String   @unique
  userId        String
  amount        Float
  response      String
  tranzilaTK    String?
  processedAt   DateTime @default(now())
}
