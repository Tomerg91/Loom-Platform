datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ROLE-BASED ENUMS
// ============================================
enum UserRole {
  ADMIN
  COACH
  CLIENT
}

enum BodyZone {
  HEAD
  THROAT
  CHEST
  SOLAR_PLEXUS
  BELLY
  PELVIS
  ARMS
  LEGS
  FULL_BODY
}

enum ClientType {
  REGISTERED // Has User account (accepted invitation)
  OFFLINE // Manually added, no User account
  INVITED // Invitation sent but not yet accepted
}

enum AvailabilityStatus {
  OPEN
  HELD
  BOOKED
}

enum GoalType {
  OKR
  SMART
  HABIT
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// ============================================
// USER & AUTHENTICATION
// ============================================
model User {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  email    String? @unique
  username String? @unique

  // ROLE MANAGEMENT
  role    UserRole @default(COACH) // Public signups default to COACH
  isAdmin Boolean  @default(false)

  // INTERNATIONALIZATION
  preferredLanguage String? @default("he")

  // PROFILE RELATIONS (1:1)
  coachProfile  CoachProfile?
  clientProfile ClientProfile?

  // SUBSCRIPTION (Relevant for COACH only)
  paymentProcessorUserId        String?   @unique
  lemonSqueezyCustomerPortalUrl String?
  subscriptionStatus            String? // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan              String? // 'starter', 'pro'
  datePaid                      DateTime?
  credits                       Int       @default(3)

  // TRANZILLA TOKENIZATION
  tranzillaToken String? // TranzilaTK for auto-renewal

  // SUBSCRIPTION RENEWAL RETRY TRACKING (Tranzilla)
  subscriptionRetryCount    Int       @default(0) // Number of failed renewal attempts
  lastRetryAttempt          DateTime? // Timestamp of last renewal attempt
  subscriptionNextRetryDate DateTime? // When to attempt next renewal

  // BOILERPLATE FIELDS
  isEmailVerified        Boolean @default(false)
  emailVerificationToken String?
  passwordResetToken     String?

  // ONBOARDING
  onboardingCompleted Boolean @default(false)
  onboardingSteps     Json? // Tracks completed onboarding steps per role

  // NOTIFICATIONS (Phase 3)
  notifications           Notification[]
  notificationPreferences NotificationPreferences?

  contactFormMessages ContactFormMessage[]
  files               File[]

  // Workspace file uploads and action item assignments
  workspaceFilesUploaded WorkspaceFile[]
  actionItemsAssigned    ActionItem[]

  // Mentor request reviews (admin only)
  mentorRequestsReviewed MentorRequest[]

  // Google Calendar integration
  calendarConnection UserCalendarConnection?
}

// ============================================
// ROLE-SPECIFIC PROFILES
// ============================================
model CoachProfile {
  id        String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String    @unique
  deletedAt DateTime?

  // MENTORING CIRCLES
  isMentor              Boolean       @default(false) // Can create and manage groups
  mentorGroups          Group[]       @relation("MentorGroups")
  groupMemberships      GroupMember[] @relation("CoachGroupMemberships")
  authoredPosts         GroupPost[]   @relation("AuthoredPosts")
  repliedToPosts        GroupPostReply[] @relation("RepliedToPosts")
  mentorRequests        MentorRequest[] // Requests to become mentor

  // A Coach manages many Clients
  clients     ClientProfile[]
  invitations ClientInvitation[]

  // Sessions logged by this Coach
  sessions CoachSession[]

  // Resources uploaded by this Coach
  resources Resource[]

  // Workspace files and action items
  workspaceFiles WorkspaceFile[]
  actionItems    ActionItem[]

  // Availability slots for scheduling
  availabilitySlots AvailabilitySlot[]
}

model ClientProfile {
  id        String    @id @default(uuid())
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?   @unique
  deletedAt DateTime?

  // A Client belongs to one Coach
  coach   CoachProfile? @relation(fields: [coachId], references: [id])
  coachId String?

  // OFFLINE CLIENT SUPPORT
  clientType       ClientType @default(OFFLINE) // REGISTERED, OFFLINE, or INVITED
  displayName      String? // Name for offline clients
  contactEmail     String? // Optional contact email (not for auth)
  avatarS3Key      String? // S3 key for client avatar photo
  lastActivityDate DateTime? // Track for "Inactive" status badge

  // The Core Feature: Somatic Logs (replaces Tasks)
  somaticLogs SomaticLog[]

  // Sessions logged by Coach
  sessions CoachSession[]

  // MODULE 10: Recurring Session Schedule
  scheduleDay      Int? // 0-6 (Sunday-Saturday)
  scheduleTime     String? // "14:00" (24h format)
  scheduleTimezone String? // IANA timezone (e.g., "America/New_York")
  nextSessionDate  DateTime? // Computed next session date in UTC
  sessionCount     Int       @default(0) // Total sessions completed

  // MODULE 11: Goals & Milestones
  goals Goal[]

  // Workspace files and action items
  workspaceFiles WorkspaceFile[]
  actionItems    ActionItem[]

  // ANALYTICS: Somatic pattern insights (cached)
  analytics SomaticLogAnalytics[]

  availabilitySlots AvailabilitySlot[]

  @@index([coachId])
}

// ============================================
// SOMATIC LOG ANALYTICS (Cached Insights)
// ============================================
model SomaticLogAnalytics {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  period          String // "30d", "90d", "365d"
  computedAt      DateTime // When this snapshot was computed
  periodStartDate DateTime // Analysis window start
  periodEndDate   DateTime // Analysis window end

  topBodyZones           Json // [{zone: string, count: int, avgIntensity: float}]
  topSensations          Json // [{sensation: string, count: int, avgIntensity: float}]
  intensityTrendOverTime Json // [{weekStart: ISO date, avgIntensity: float}]
  totalLogsInPeriod      Int // Total somatic logs in this period

  @@unique([clientId, period])
  @@index([clientId])
  @@index([computedAt])
}

// ============================================
// CLIENT INVITATIONS
// ============================================
model ClientInvitation {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  coachId   String
  status    String    @default("PENDING") // PENDING, ACCEPTED
  createdAt DateTime  @default(now())
  expiresAt DateTime
  deletedAt DateTime?

  // Link to coach so they can see pending invites
  coach CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId, status])
}

// ============================================
// SOMATIC LOGS (Core Feature)
// ============================================
model SomaticLog {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  // The Data Point
  bodyZone  BodyZone
  sensation String // e.g., "Tight", "Hot", "Vibrating"
  intensity Int // 1-10 scale
  note      String?  @db.Text

  // SHARING CONTROL
  sharedWithCoach Boolean @default(true) // Controls coach visibility

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  @@index([clientId, createdAt])
  @@index([clientId, sharedWithCoach, deletedAt])
}

// ============================================
// COACH SESSIONS (Module 9: Session Recaps)
// ============================================
model CoachSession {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  sessionDate DateTime  @default(now())
  deletedAt   DateTime?

  // MODULE 10: Session tracking
  sessionNumber Int? // Auto-incremented for each client's sessions
  topic         String? // e.g., "Work Stress"

  // Coach-visible only
  privateNotes String? @db.Text

  // Visible to both Coach and Client
  sharedSummary String? @db.Text

  // HARMONY UPDATE: Somatic Anchor & Resource Attachments
  somaticAnchor BodyZone? // Body zone discussed in session
  resources     Resource[] // Resources attached as homework

  // Workspace files and action items linked to this session
  workspaceFiles WorkspaceFile[]
  actionItems    ActionItem[]

  // Google Calendar integration
  googleCalendarEvent GoogleCalendarEvent?

  // Relations
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId String

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  @@index([coachId, sessionDate])
  @@index([clientId, sessionDate])
  @@index([clientId, sessionDate, deletedAt])
}

model AvailabilitySlot {
  id        String             @id @default(uuid())
  coach     CoachProfile       @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId   String
  client    ClientProfile?     @relation(fields: [clientId], references: [id])
  clientId  String?
  startTime DateTime
  endTime   DateTime
  timezone  String
  status    AvailabilityStatus @default(OPEN)
  notes     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  deletedAt DateTime?

  @@index([coachId, startTime, deletedAt])
  @@index([clientId, startTime, deletedAt])
}

// ============================================
// GOALS & MILESTONES (Module 11)
// ============================================
model Goal {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  title    String
  type     GoalType   @default(OKR)
  status   GoalStatus @default(NOT_STARTED)
  progress Int        @default(0) // 0-100, calculated from milestones
  dueDate  DateTime?

  // Relations
  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  // Milestones for this goal
  milestones Milestone[]

  @@index([clientId, status])
  @@index([clientId, deletedAt])
  @@index([clientId, dueDate])
}

model Milestone {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  text      String
  completed Boolean @default(false)
  order     Int     @default(0) // For ordering within a goal

  // Relations
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)
  goalId String
}

// ============================================
// FILE UPLOADS
// ============================================
model File {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  user   User   @relation(fields: [userId], references: [id])
  userId String

  name  String
  type  String
  s3Key String

  @@index([userId, deletedAt])
}

// ============================================
// RESOURCE LIBRARY (Module 8)
// ============================================
model Resource {
  id          String    @id @default(uuid())
  name        String
  type        String // MIME type: "application/pdf", "image/jpeg", "audio/mpeg", etc.
  s3Key       String
  description String? // Optional description for coaches
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?

  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId String

  // HARMONY UPDATE: Resource can be attached to sessions
  sessions CoachSession[] // Sessions where this resource was prescribed

  @@index([coachId])
  @@index([coachId, deletedAt])
}

// ============================================
// WORKSPACE (Shared Files & Action Items)
// ============================================
model WorkspaceFile {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  // Coach-Client Pair
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId String

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  // Optional: Link to specific session
  session   CoachSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  sessionId String?

  // File metadata
  name  String
  type  String // MIME type: "application/pdf", "image/jpeg", etc.
  s3Key String

  // Track who uploaded
  uploadedBy   User   @relation(fields: [uploadedByUserId], references: [id], onDelete: Restrict)
  uploadedByUserId String

  @@index([coachId, clientId])
  @@index([clientId, deletedAt])
  @@index([sessionId])
}

model ActionItem {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  // Coach-Client Pair
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId String

  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  // Optional: Link to specific session
  session   CoachSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  sessionId String?

  // Action item details
  title       String
  description String? @db.Text
  dueDate     DateTime?

  // Completion tracking
  completed   Boolean   @default(false)
  completedAt DateTime?

  // Track who assigned
  assignedBy   User   @relation(fields: [assignedByUserId], references: [id], onDelete: Restrict)
  assignedByUserId String

  @@index([coachId, clientId])
  @@index([clientId, completed])
  @@index([clientId, dueDate])
  @@index([sessionId])
}

// ============================================
// ANALYTICS & ADMIN
// ============================================
model AdminSettings {
  id                String   @id
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  fullName          String
  phoneNumber       String?
  emailAddress      String
  username          String
  bio               String?
  avatarS3Key       String?
  privacyPolicyUrl  String
  termsOfServiceUrl String
}

model DailyStats {
  id   Int      @id @default(autoincrement())
  date DateTime @unique @default(now())

  totalViews                Int    @default(0)
  prevDayViewsChangePercent String @default("0")
  userCount                 Int    @default(0)
  paidUserCount             Int    @default(0)
  userDelta                 Int    @default(0)
  paidUserDelta             Int    @default(0)
  totalRevenue              Float  @default(0)
  totalProfit               Float  @default(0)

  sources PageViewSource[]
}

model PageViewSource {
  name String
  date DateTime @default(now())

  dailyStats   DailyStats? @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId Int?

  visitors Int

  @@id([date, name])
}

model Logs {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  message String
  level   String
}

model ContactFormMessage {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  content   String
  isRead    Boolean   @default(false)
  repliedAt DateTime?
}

// ============================================
// NOTIFICATIONS (Phase 3)
// ============================================
model Notification {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  type    String // "SESSION_REMINDER", "SESSION_SUMMARY_POSTED", "RESOURCE_SHARED"
  title   String
  message String  @db.Text
  read    Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  metadata Json? // {sessionId, resourceId, clientId, etc}

  @@index([userId, read])
  @@index([createdAt])
}

model NotificationPreferences {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  emailSessionReminders Boolean @default(true)
  emailSessionSummaries Boolean @default(true)
  emailResourceShared   Boolean @default(true)

  inAppSessionReminders Boolean @default(true)
  inAppSessionSummaries Boolean @default(true)
  inAppResourceShared   Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

// ============================================
// TRANZILLA TRANSACTIONS
// ============================================
model TranzillaTransaction {
  id            String   @id @default(uuid())
  transactionId String   @unique
  userId        String
  amount        Float
  response      String
  tranzilaTK    String?
  processedAt   DateTime @default(now())
}

// ============================================
// GOOGLE CALENDAR INTEGRATION
// ============================================
model UserCalendarConnection {
  id String @id @default(uuid())

  // Which user owns this connection
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Google Calendar info
  calendarId   String // User's Google Calendar ID (from service account perspective)
  calendarName String? // e.g., "Loom Platform" calendar we created
  isConnected  Boolean @default(true)

  // Metadata
  connectedAt    DateTime  @default(now())
  lastSyncAt     DateTime?
  syncErrorCount Int       @default(0)
  lastErrorAt    DateTime?
  lastError      String?   @db.Text

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GoogleCalendarEvent {
  id String @id @default(uuid())

  // Link to session that created this
  session   CoachSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String       @unique

  // Google Calendar event ID (used to update/delete later if needed)
  googleEventId String

  // Track sync status
  syncedAt  DateTime @default(now())
  createdAt DateTime @default(now())
}

// ============================================
// MENTOR REQUEST (Admin Approval Required)
// ============================================
model MentorRequest {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Coach requesting mentor status
  coachProfile  CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId       String

  // Request status
  status        String    @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED'
  rejectionNote String?   @db.Text // Reason if rejected

  // Admin who approved/rejected
  reviewedBy   User?     @relation(fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  reviewedByUserId String?
  reviewedAt    DateTime?

  @@index([coachId, status])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// MENTORING CIRCLES (Phase 2)
// ============================================
model Group {
  id        String   @id @default(uuid())
  name      String
  description String? @db.Text
  createdAt DateTime @default(now())
  deletedAt DateTime?

  // Mentor who created this group
  mentor      CoachProfile @relation("MentorGroups", fields: [mentorId], references: [id], onDelete: Cascade)
  mentorId    String

  // Group members (coaches only)
  members GroupMember[]

  // Posts in this group
  posts GroupPost[]

  @@index([mentorId])
  @@index([deletedAt])
}

model GroupMember {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  deletedAt DateTime?

  // Invitation tracking (follows ClientInvitation pattern)
  status   String   @default("ACTIVE") // 'PENDING', 'ACTIVE', 'DECLINED'
  joinedAt DateTime? // When member accepted invitation

  // Which group
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId String

  // Which coach
  coach      CoachProfile @relation("CoachGroupMemberships", fields: [coachId], references: [id], onDelete: Cascade)
  coachId    String

  @@unique([groupId, coachId])
  @@index([groupId])
  @@index([coachId])
  @@index([groupId, status]) // For filtering active/pending members
}

model GroupPost {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Post metadata
  postType   String  @default("STANDARD") // 'STANDARD', 'WIN', 'BLIND_REFLECTION' - single source of truth
  isPinned   Boolean @default(false) // Mentors can pin important posts
  editedAt   DateTime? // Track post edits for transparency

  // Which group
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId String

  // Author (coach who posted)
  author      CoachProfile @relation("AuthoredPosts", fields: [authorId], references: [id], onDelete: Cascade)
  authorId    String

  // Replies to this post
  replies GroupPostReply[]

  @@index([groupId, createdAt])
  @@index([groupId, postType]) // Filter by post type
  @@index([groupId, isPinned, createdAt]) // Fetch pinned posts first
  @@index([deletedAt])
}

model GroupPostReply {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  deletedAt DateTime?

  // Which post
  post   GroupPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String

  // Author (coach who replied)
  author      CoachProfile @relation("RepliedToPosts", fields: [authorId], references: [id], onDelete: Cascade)
  authorId    String

  @@index([postId, createdAt])
  @@index([postId, deletedAt]) // Composite index for common WHERE clause (postId + soft delete filtering)
  @@index([authorId])
  @@index([deletedAt])
}
